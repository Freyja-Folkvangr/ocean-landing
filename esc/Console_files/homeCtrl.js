define(["language/home","language/common","app/business/common/services/resourceName"],function(i18n,i18nCommon,resourceName){"use strict";var homeCtrl=["$scope","$state","$q","frameworkService","homeService","mask",function($scope,$state,$q,frameworkService,homeService,mask){function initUserInfo(){if(!$scope.domainId)return;$scope.isBmsUser=$.inArray("op_gated_bms",$scope.userRoles)<0;$scope.toSubmitNum="-";$scope.myToDoNum="-"}function initOrderNumber(){var options1,options2;if(!$scope.userId||!$scope.vdcId)return;options1={"vdcId":$scope.vdcId,"params":{"list-type":"approve"}};homeService.queryOrders(options1).then(function(data){$scope.myToDoNum=dealDashboardNum(data.total)},function(){$scope.myToDoNum=0});options2={"vdcId":$scope.vdcId,"params":{"list-type":"save"}};homeService.queryOrders(options2).then(function(data){$scope.toSubmitNum=dealDashboardNum(data.total)},function(){$scope.toSubmitNum=0})}function dealDashboardNum(insNum){if(!$.isNumeric(insNum))return 0;insNum>=1e3&&(insNum="999+");return insNum}function dealServicelist(){var endpoints,tmpNonsupportRegions,toEndpoints,index2,index1;if(!$scope.serviceEndpoints||!$scope.endpointInitFlag)return;$scope.endpointInitFlag&&mask.hide();endpoints=$scope.serviceEndpoints;toEndpoints=[];if(endpoints)for(index1=0;index1<endpoints.length;index1++){for(index2=0;index2<endpoints[index1].endpoints.length;index2++){endpoints[index1].endpoints[index2].instanceNum=0;endpoints[index1].endpoints[index2].disable=!1;tmpNonsupportRegions=endpoints[index1].endpoints[index2].nonsupportRegion;tmpNonsupportRegions&&$scope.isNonsupportRegion(tmpNonsupportRegions,$scope.projectName)&&(endpoints[index1].endpoints[index2].disable=!0);endpoints[index1].endpoints[index2].links=orderLinks(endpoints[index1].endpoints[index2].links)}toEndpoints.push(endpoints[index1])}$scope.homeServiceList=toEndpoints;initAllServiceInstanceNum()}function orderLinks(links){var index,result={};if(links)for(index=0;index<links.length;index++)result[links[index].text]=links[index];return result}function initAllServiceInstanceNum(){var index2,index1;if(!$scope.selectRegionId)return;if(!$scope.homeServiceList||0===$scope.homeServiceList.length)return;for(index1=0;index1<$scope.homeServiceList.length;index1++)for(index2=0;index2<$scope.homeServiceList[index1].endpoints.length;index2++)$scope.homeServiceList[index1].endpoints[index2].defaultOpen||$scope.homeServiceList[index1].endpoints[index2].disable||initServiceInstanceNum(index1,index2)}function dealInstanceNum(instanceNum){instanceNum>=100&&(instanceNum="99+");return instanceNum}function initServiceInstanceNum(index1,index2){var dbPromise,pdbPromise,options={"serviceId":$scope.homeServiceList[index1].endpoints[index2].id,"tenantId":$scope.projectId};"rds"===options.serviceId&&(options.tenantId=$scope.domainId);"dec"===options.serviceId&&(options.params={"project_name":$scope.projectName,"domain_id":$scope.domainId});if("vfw"===options.serviceId)return;$scope.homeServiceList[index1].endpoints[index2].instanceNum=0;if("oracle"===options.serviceId){dbPromise=homeService.getOracleDbNum(options);pdbPromise=homeService.getOraclePdbNum(options);$q.all([dbPromise,pdbPromise]).then(function(datalist){$scope.homeServiceList[index1].endpoints[index2].instanceNum=dealInstanceNum(datalist[0].totalNum+datalist[1].totalNum)})}else{"vapp"===options.serviceId&&(options.params={"region_id":$scope.selectRegionId,"start":0,"limit":1});homeService.getInstanceNum(options).then(function(data){var tmpInstanceNum=0;if(data){data.instanceNum?tmpInstanceNum=data.instanceNum:data.instance_num?tmpInstanceNum=data.instance_num:data.image_count?tmpInstanceNum=data.image_count:data.servers?tmpInstanceNum=data.servers.length:data.vpcs?tmpInstanceNum=data.vpcs.length:data.images?tmpInstanceNum=data.images.length:data.total_number?tmpInstanceNum=data.total_number:data.volumes?tmpInstanceNum=data.volumes.length:data.backups?tmpInstanceNum=data.backups.length:data.directconnections?tmpInstanceNum=data.directconnections.length:data.ipsec_site_connections?tmpInstanceNum=data.ipsec_site_connections.length:data.zones?tmpInstanceNum=data.zones.length:data.loadbalancers?tmpInstanceNum=data.loadbalancers.length:data.publicips?tmpInstanceNum=data.publicips.length:data.total_count?tmpInstanceNum=data.total_count:data.services?tmpInstanceNum=data.services.length:data.instances?tmpInstanceNum=data.instances.length:data.vpnservices?tmpInstanceNum=data.vpnservices.length:data.firewalls?tmpInstanceNum=data.firewalls.length:data.firewall_groups?tmpInstanceNum=data.firewall_groups.length:data.total&&(tmpInstanceNum=data.total);$scope.homeServiceList[index1].endpoints[index2].instanceNum=dealInstanceNum(tmpInstanceNum)}})}}mask.show();$scope.i18n=i18n=_.extend(i18n,i18nCommon);$scope.home_user_head_href={"url":"/static/framework/theme/default/images/home/user-head.png"};$scope.homeServiceList=[];$scope.toSubmitNum=0;$scope.myToDoNum=0;$scope.quota_resources=[];$scope.quota_element=[];$scope.isBmsUser=!1;$scope.canApply=function(){return!1};$scope.apply=function(endpoint){var type=$scope.valueConvert(endpoint.id,"endpointId","serviceType"),options={"type":type,"status":"published","cloudInfraId":$scope.selectRegionId,"vdcId":$scope.vdcId};homeService.queryProducts(options).then(function(data){var msgWidth,noProductMsg,msgoption,msg,winoptions,win;if(!(data&&data.products&&data.products.length)){msgWidth="zh-cn"===$scope.language?350:420;noProductMsg="<span style = 'font-size: 1.2em'>"+$scope.i18nReplace(i18n.conhome_term_noProduct_label,{"1":resourceName[type.toUpperCase()]})+"</span>";noProductMsg+=$scope.isVdcMgr?"<br><br><a href='#/taskCenter/taskCenterLeft/productList?productType="+type+"'>"+i18n.conhome_term_publish_label+"</a>":"<br><br><span>"+i18n.conhome_term_contact_admin_label+"</span>";msgoption={"type":"warn","width":msgWidth,"buttons":[{"key":"btnId1","label":i18n.common_term_close_button,"focused":!0,"handler":function(){msg.destroy()}}],"content":noProductMsg};msg=new tinyWidget.Message(msgoption);msg.show();return}winoptions={"winId":"createServicesWindow","title":i18n.conhome_term_choose_button,"type":endpoint.id,"cloudInfraId":$scope.selectRegionId,"content-type":"url","content":"src/app/business/home/views/serviceList.html","height":"","width":"850","maximizable":!1,"minimizable":!1,"buttons":[{"key":"cancelBtn","label":i18n.common_term_close_button,"focused":!1,"handler":function(){win.destroy()}}],"close":function(){}};win=new tinyWidget.Window(winoptions);win.show()})};$scope.$watch("domainId",initUserInfo);$scope.$watch("selectRegionId",initAllServiceInstanceNum);$scope.$watch("endpointInitFlag",dealServicelist);$scope.$watch("user_head_all",function(){$scope.user_head_all&&$scope.user_head_all.big&&($scope.home_user_head_href.url=$scope.user_head_all.big)});$scope.$watch("userId",initOrderNumber);$scope.$watch("vdcId",initOrderNumber);$scope.$watch("curRegion",initAllServiceInstanceNum);$scope.clickHref=function(href,target,event){event=event?event:window.event;var targetObj=event.srcElement?event.srcElement:event.target;if(targetObj&&targetObj.tagName&&"A"===targetObj.tagName.toLocaleUpperCase()&&targetObj.hasClass("detail-link"))return;"_self"===target?window.location.href=$scope.genHWSHref(href):window.open(href)};$scope.viewQuota=function(){var options={"title":$scope.i18n.conhome_term_serviceQuota_label,"width":780,"height":600,"top":100,"content":"src/app/business/home/views/quotaList.html","content-type":"url","resizable":!1,"buttons":[{"key":"closeBtn"}]},win=new tinyWidget.Window(options);win.setButton("closeBtn",function(){win.destroy()},i18n.common_term_close_button);win.show();mask.show()}}],homeModule=angular.module("home.config");homeModule.tinyController("home.ctrl",homeCtrl);return homeModule});