define(["bootstrap/bootstrap.min","app-remote/framework/localization/config","app-remote/framework/configures/servicesConfig","app-remote/framework/configures/vdcMenusConfig"],function(bootstrap,localizationConfig,servicesConfig,vdcMenusConfig){"use strict";var ctrl=function($rootScope,$scope,frameworkService,globalRegionName,currentService,$sce,$state,$location,$q,storage,mask){function initUserHead(){frameworkService.queryIamUser($rootScope.userId).then(function(data){if(data&&data.user&&data.user.img_path){$rootScope.user_head_all=data.user.img_path;data.user.img_path.small&&($rootScope.user_head_href.url=data.user.img_path.small)}})}function initRegions(){promiseRegion.then(function(data){if(!data||!data.regions)return;$rootScope.tmpRegions=data.regions})}function pageInit(){initAllUserInfo();initRegions();initAllLinks()}function initAllUserInfo(){initUserInfo()}function initAllLinks(){frameworkService.getLinks().then(function(data){var links,key,index;if(data&&data.links){links={};key="";for(index=0;index<data.links.length;index++){key=data.links[index].key+"_"+data.links[index].type;links[key]=data.links[index].href}$rootScope.links=links}})}function initUserInfo(){var endpointsPromise,userPromise=frameworkService.getLoginUser();userPromise.then(function(data){var reg,checkADUserPromise;if(!data)return $q.reject();endpointsPromise=frameworkService.queryEndpoints({"region":data.region});reg=/^op_svc[\d\w_-]+$/;if(reg.test(data.name))return $q.all([userPromise]);checkADUserPromise=frameworkService.checkADUser({"domainId":data.domainId,"userId":data.id,"userName":data.name}).then(function(){},function(){});return $q.all([userPromise,checkADUserPromise])}).then(function(dataList){var licensePromise,reg=/^op_svc[\d\w_-]+$/;if(reg.test(dataList[0].name)){$rootScope.isResourceMgr=!0;$rootScope.isOptSvc=!0;return $q.all([userPromise])}licensePromise=frameworkService.checkLicense().then(function(data){if(data&&data.licenseInvalidateNormal)return $q.all([userPromise,frameworkService.getUserInfo({"userId":dataList[0].id})]);setTimeout(function(){var configs={"type":"warn","content":$rootScope.i18n.console_term_licenseDisable_label,"closeable":!1,"width":"360px","height":"200px","buttons":[{"label":$rootScope.i18n.console_term_comfirm_button,"focused":!0,"handler":function(){msg.destroy();$rootScope.logout()}}]},msg=new tinyWidget.Message(configs);msg.show();mask.hide()},1e3);return!1});return licensePromise}).then(function(dataList){var roles,data=dataList[0],user=dataList[1]&&dataList[1].user;if(user){roles=user.roles;$rootScope.isVdcMgr=_.some(roles,function(role){return"0"===role.role_type});$rootScope.isResourceMgr=_.some(roles,function(role){return"1"===role.role_type});$rootScope.resourceTenantId=user.resource_tenant_id;$rootScope.vdcId=user.vdc_id}$rootScope.displayMenuElements(!$rootScope.isVdcMgr);$rootScope.rolesInitFlag=!0;$rootScope.userId=data.id;$rootScope.username=data.name;$rootScope.projectId=data.projectId;$rootScope.projectName=data.region;$rootScope.userRoles=data.roles;data.nonsupportRegions&&($rootScope.nonsupportRegions=data.nonsupportRegions);if($rootScope.nonsupportRegions&&$rootScope.isNonsupportRegion($rootScope.nonsupportRegions,$rootScope.projectName)){$rootScope.lastState=$state.current;"nonsupportRegion"!==$rootScope.lastState.name&&$state.go("nonsupportRegion")}if($.inArray("op_vendor_sub_user",data.roles)>=0){$rootScope.isVendorSubUser=!0;$rootScope.isVendorUser=!0}$.inArray("op_vendor",data.roles)>=0&&($rootScope.isVendorUser=!0);$.inArray("op_legacy",data.roles)>=0&&localizationConfig.isOldUser&&($rootScope.isOldUser=!0);$rootScope.isPcVendorSubuser=$.inArray("op_gated_pc_vendor_subuser",data.roles)>=0;$rootScope.domainId=data.domainId;$rootScope.roleHide=$rootScope.vdcId!==$rootScope.domainId;initUserHead();$rootScope.$broadcast("initUser");promiseRegion.then(function(){initUserProjects()});initDefaultRegion();getAssumeRoles();return endpointsPromise}).then(function(endpoints){dealAllEndpoints(endpoints);beautifierEndpoints();getOrgEndpoints();var reg=/^op_svc[\d\w_-]+$/;reg.test($rootScope.username)||beautifierProductEndpoints()})}function getDisplayRegionName(regionId){if(regionId&&projectNameRegExp.test(regionId)){var projectElms=regionId.match(projectNameRegExp);0===regionId.indexOf("DeC")&&($rootScope.isVdcRegion=!0);return getRegionNameById(projectElms[2])+"("+projectElms[3]+")"}return getRegionNameById(regionId)}function initDefaultRegion(){if(globalRegionName+""==""){if($rootScope.regions.length>0&&""!==$rootScope.projectName){$rootScope.selectRegionId=getProjectRegionId($rootScope.projectName);$rootScope.displayRegionName=getDisplayRegionName($rootScope.projectName);$rootScope.$broadcast("initDefaultRegion")}}else{$rootScope.selectRegionId=getProjectRegionId($rootScope.projectName);$rootScope.displayRegionName=globalRegionName;$rootScope.$broadcast("initDefaultRegion")}}function getRegionNameById(regionId){var region=_.find($rootScope.regions,function(region){return region.id===regionId});return region&&region.name||""}function getProjectRegionId(projectName){if(projectName&&projectNameRegExp.test(projectName))return projectName.match(projectNameRegExp)[2];return projectName}function initUserProjects(){frameworkService.getUserProjects().then(function(data){data&&data.projects&&genProjectList(data.projects)},function(){genProjectList(null)})}function genProjectList(sProjects){var index,projectElms,regions,projects={};if(sProjects)for(index=0;index<sProjects.length;index++)if(sProjects[index]&&sProjects[index].name&&projectNameRegExp.test(sProjects[index].name)){projectElms=sProjects[index].name.match(projectNameRegExp);projects[projectElms[2]]=projects[projectElms[2]]||[];projects[projectElms[2]].push({"id":sProjects[index].name,"name":sProjects[index].name,"projectId":sProjects[index].id,"displayName":projectElms[3],"disable":$rootScope.isNonsupportRegion($rootScope.nonsupportRegions,sProjects[index].name)})}regions=$rootScope.tmpRegions;for(index=0;index<regions.length;index++){regions[index].projects=projects[regions[index].id];regions[index].disable=$rootScope.nonsupportRegions&&$rootScope.isNonsupportRegion($rootScope.nonsupportRegions,regions[index].id)}$rootScope.regions=regions;initDefaultRegion()}function getOrgEndpoints(){_.each(vdcMenusConfig,function(item){if(item.flag&&"role"===item.flag){item.hide=$rootScope.roleHide;item.children[0].hide=$rootScope.roleHide}});$rootScope.orgEndpoints=vdcMenusConfig}function dealAllEndpoints(data){var endpoints,tmpEndpoints,endpoint,item;if(!data||!data.endpoints)return;endpoints=data.endpoints;tmpEndpoints=[];for(item=0;item<endpoints.length;item++){endpoint=endpoints[item];endpoint.id===window.global_endpoint_id&&($rootScope.endpointName=endpoint.name);"home"===endpoint.id?$rootScope.homeEndpoint=endpoint:tmpEndpoints.push(endpoint)}$rootScope.serviceEndpointList=tmpEndpoints;"/console/"!=window.location.pathname&&$rootScope.isVdcMgr&&$rootScope.goHome()}function beautifierEndpoints(flag){var catalogs,endpoint,catalog,item,result,index,endpoints=$rootScope.serviceEndpointList;if(!endpoints)return[];catalogs={};for(item=0;item<endpoints.length;item++){endpoint=endpoints[item];catalog=$.trim(endpoint.catalog);catalogs[catalog]=catalogs[catalog]||[];catalogs[catalog].push(endpoint)}result=[];for(index in catalogs)catalogs.hasOwnProperty(index)&&result.push({"catalog":index,"endpoints":catalogs[index]});$rootScope.serviceEndpoints=result;flag||($rootScope.endpointInitFlag=!0)}function beautifierProductEndpoints(){var productEndpoints,productEndpointIds=_.map(servicesConfig,function(config){return!config.noProduct&&config.endpointId});productEndpointIds=_.filter(productEndpointIds);productEndpoints=angular.copy($rootScope.serviceEndpoints);productEndpoints=_.filter(productEndpoints,function(catalog){catalog.endpoints=_.filter(catalog.endpoints,function(endpoint){return _.contains(productEndpointIds,endpoint.id)});return catalog.endpoints&&catalog.endpoints.length});$rootScope.productEndpoints=productEndpoints;$rootScope.productCurrent.catalog=$rootScope.productEndpoints[0];$rootScope.productCurrent.endpoint=$rootScope.productCurrent.catalog&&$rootScope.productCurrent.catalog.endpoints[0];dealSpecialProducts()}function dealSpecialProducts(){frameworkService.querySpecialProducts({}).then(function(data){var link,addOrReplaceUrlParameter,products,specialProducts=data&&data.specialProducts;if(!specialProducts)return;link=$rootScope.links.product_detail;addOrReplaceUrlParameter=$rootScope.addOrReplaceUrlParameter;_.each(specialProducts,function(product){product.link=addOrReplaceUrlParameter(link,"serviceId",product.id);product.link=addOrReplaceUrlParameter(product.link,"type",product.service_id);product.name=window.htmlDecode.done(product.name);product.description=window.htmlDecode.done(product.description)});products=_.groupBy(specialProducts,function(product){return valueConvert(product.service_id,"serviceType","endpointId")});_.each($rootScope.productEndpoints,function(catalog){_.each(catalog.endpoints,function(endpoint){endpoint.products=endpoint.products||products[endpoint.id]})})})}function getAssumeRoles(){var options={"userId":$rootScope.userId,"limit":$rootScope.limit};frameworkService.getAssumeRoles(options).then(function(data){if(data){if(data.account&&data.account.id&&data.account.id!==$rootScope.userId){$rootScope.isLoginUserFlag=!1;$rootScope.hasAssumeRoleFlag=!0;$rootScope.loginUserAccount=data.account;var tmpIndex=$rootScope.username.indexOf("/");if(tmpIndex>0){$rootScope.company=$rootScope.username.substring(tmpIndex+1);$rootScope.shortName=$rootScope.username.substring(0,tmpIndex)}}else{$rootScope.isLoginUserFlag=!0;$rootScope.hasAssumeRoleFlag=!1}if(data.xrole_history&&data.xrole_history.length>0){$rootScope.assumeRoles=data.xrole_history;$rootScope.hasAssumeRoleFlag=!0}}else{$rootScope.assumeRoles=[];$rootScope.hasAssumeRoleFlag=!1}})}var promiseRegion,dom,i18nSubRegRex=/\{\s*([^|}]+?)\s*(?:\|([^}]*))?\s*}/g,projectNameRegExp=/^([^_]+)_([^_]+)_(.+)$/,valueConvert=$rootScope.valueConvert;window.htmlDecode={};window.htmlDecode.done=function(text){if(!text)return text;return text.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#92;/g,"\\").replace(/&apos;/g,"'").replace(/&amp;/g,"&").replace(/&#40;/g,"(").replace(/&#41;/g,")")};$rootScope.i18nReplace=function(s,o){if(!s||!o)return;return s.replace?s.replace(i18nSubRegRex,function(match,key){return angular.isUndefined(o[key])?match:o[key]}):s};$rootScope.widgetsLanguage=window.tinyLanguage.language;$rootScope.timeFormat=$rootScope.i18n.dateFormat+" HH:mm:ss";$rootScope.tmpRegions=[];$rootScope.regions=[];$rootScope.projects={};$rootScope.selectRegionId="";$rootScope.projectName="";$rootScope.displayRegionName="";$rootScope.isVdcRegion=!1;$rootScope.noticeNum=0;$rootScope.username="";$rootScope.company="";$rootScope.userId="";$rootScope.projectId="";$rootScope.domainId="";$rootScope.userRoles=[];$rootScope.isOldUser=!1;$rootScope.importantMessages=[];$rootScope.homeEndpoint=null;$rootScope.serviceEndpoints=[];$rootScope.productEndpoints=[];$rootScope.orgEndpoints=[];$rootScope.serviceEndpointList=[];$rootScope.isLoginUserFlag=!0;$rootScope.loginUserAccount={};$rootScope.hasAssumeRoleFlag=!1;$rootScope.assumeRoles=[];$rootScope.links=[];$rootScope.isVendorSubUser=!1;$rootScope.endpointInitFlag=!1;$rootScope.elementDisplayFlag=!0;$rootScope.regionDisplayFlag=!1;$rootScope.isOptSvc=!1;$rootScope.globalRegionName=globalRegionName;$rootScope.currentService=currentService;$rootScope.bussinessConsoleList=["authCenter","marketplace","userCenter"];$rootScope.isServiceConsole=$.inArray($rootScope.currentService,$rootScope.bussinessConsoleList)<0;$rootScope.currentServiceName=$rootScope.i18n["console_term_"+$rootScope.currentService+"_label"];$rootScope.logoutUrl=window.appWebPath+"/logout";$rootScope.lastState="";$rootScope.canAssumeRole=localizationConfig.canAssumeRole;$rootScope.console_term_copyright_label=$sce.trustAsHtml($rootScope.i18n.console_term_copyright_label);$rootScope.user_head_href={"url":"/static/framework/theme/default/images/user-head.png"};$rootScope.user_head_all={};$rootScope.nonsupportRegions=[];$rootScope.displayMenuElements=function(flag){$rootScope.regionDisplayFlag=flag};$rootScope.displayMenusWithOutRegion=function(){};$rootScope.logout=function(){storage.flush();window.location.href=$rootScope.logoutUrl};promiseRegion=frameworkService.queryRegions();$rootScope.collectTips={"collectTooltip":{"content":$rootScope.i18n.console_term_collect_tip,"width":300,"containerStyle":"frame-dropdown-tinyTip","position":"bottom-right"},"unCollectTooltip":{"content":$rootScope.i18n.console_term_unCollect_tip,"width":300,"containerStyle":"frame-dropdown-tinyTip","position":"bottom-right"}};$rootScope.oldTips={"tooltip":{"content":$rootScope.i18n.console_term_oldConsoleTips_label,"width":180,"containerStyle":"frame-dropdown-tinyTip old-console-tips","position":"bottom"}};$rootScope.helpTips={"tooltip":{"content":$rootScope.i18n.console_term_helpcenter_label,"width":100,"containerStyle":"frame-dropdown-tinyTip frame-helpcenter-tips","position":"bottom"}};$rootScope.productCurrent={"catalog":[],"endpoint":[]};pageInit();$rootScope.$on("$stateChangeStart",function(event,toState){if("nonsupportRegion"!==toState.name&&$rootScope.nonsupportRegions&&$rootScope.isNonsupportRegion($rootScope.nonsupportRegions,$rootScope.projectName)){$rootScope.lastState=toState;event.preventDefault()}});$rootScope.isNonsupportRegion=function(nonsupportRegions,regionId){var i,result=!1;if(regionId&&projectNameRegExp.test(regionId)){for(i=0;i<nonsupportRegions.length;i++)if(nonsupportRegions[i]&&0===regionId.indexOf(nonsupportRegions[i])){result=!0;break}}else result=nonsupportRegions.indexOf(regionId)>=0;return result};$rootScope.changeRegion=function(projectName){if($rootScope.isNonsupportRegion($rootScope.nonsupportRegions,projectName))return;frameworkService.changeRegion({"project":projectName}).then(function(){var href=$rootScope.delUrlParameter(window.location.href,"agencyId");href=$rootScope.delUrlParameter(href,"region");$rootScope.projectName=projectName;"nonsupportRegion"===$state.current.name||"beingMaintained"===$state.current.name||"accessDeclined"===$state.current.name?window.location.href=href.replace("#"+$location.url(),""):href===window.location.href?window.location.reload():window.location.href=href})};$rootScope.assumeRole=function(agencyId){if(agencyId){var options={"agencyId":agencyId};frameworkService.assumeRole(options).then(function(){var href=$rootScope.delUrlParameter(window.location.href,"agencyId");href=$rootScope.delUrlParameter(href,"region");href===window.location.href?window.location.reload():window.location.href=href})}};$rootScope.assumeRoleToIAM=function(){var href,iamHref;if($rootScope.links.assume_role_iam+""=="")return;href=$rootScope.delUrlParameter(window.location.href,"agencyId");href=$rootScope.delUrlParameter(href,"region");iamHref=$rootScope.addOrReplaceUrlParameter($rootScope.links.assume_role_iam,"callbackurl",encodeURIComponent(href));window.location.href=$rootScope.genHWSHref(iamHref)};$rootScope.goHome=function(){window.location.href=$rootScope.isServiceConsole?$rootScope.genHWSHref($rootScope.homeEndpoint.endpoint):$rootScope.genHWSHref($rootScope.links.console_common,"locale")};$scope.queryOrderCount=function(){if($("#userCenterMenuId").hasClass("open"))return;var options=[{"type":"todo"},{"type":"apply"},{"type":"all"}];_.each(options,function(item){frameworkService.queryOrders(item).then(function(data){$scope[item.type+"Count"]="("+data.total+")"})})};if(storage.get("framework_tips_new_msg"+storage.cookieStorage.getItem("agencyID"))){dom=$(".frame-message-round");dom&&dom.css("display","block")}$rootScope.recharge=function(){window.open($rootScope.genHWSHref($rootScope.links.recharge_userCenter))}};ctrl.$injector=["$rootScope","$scope","frameworkService","globalRegionName","currentService","$state","$location","$q","mask"];return ctrl});