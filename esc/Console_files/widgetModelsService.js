define([],function(){"use strict";var widgetModelsService=function($q){function extend(Child,Parent){function Tmp(){}var arg,i,l,prototypes=[];if(Parent instanceof Function){Tmp.prototype=Parent.prototype;prototypes.push(new Tmp)}else prototypes.push(Parent);for(i=2,l=arguments.length;l>i;i++){arg=arguments[i];prototypes.push(arg instanceof Function?arg.prototype:arg)}Child.prototype=_.extend.apply(null,prototypes);Child.prototype.constructor=Child}function getAttributeByString(obj,attrName){var attrNames,attr;if(!obj||!attrName)return void 0;attrNames=attrName.split(".");attr=obj;for(;attrNames.length>0&&attr;)attr=attr[attrNames.shift()];return attr}function checkNecessaryOptions(necessaryOptionsKeys,options){var optionsKeys=_.keys(options),loseNecessaryOptions=_.difference(necessaryOptionsKeys,optionsKeys);if(loseNecessaryOptions.length>0)throw new Error("lose necessary options: "+loseNecessaryOptions)}function getLimitValue(value,min,max){var valueNum=Number(value),minNum=Number(min),maxNum=Number(max);return isNaN(valueNum)||minNum>valueNum?minNum:valueNum>maxNum?maxNum:valueNum}function WidgetBaseModel(options){if(!(this instanceof WidgetBaseModel))throw new Error("must be use keyword: new");if(!options||!options.scope)throw new Error("lose necessary option: scope");options=_.extend({"scope":{},"id":"","display":!0,"disable":!1,"require":!1,"valuePromiseChangeFlag":0/0,"valueChangeFlagPosition":"","dependency":[],"valuePromise":null,"widget":null},options);_.extend(this,options);this.valueChangeFlagPosition||(this.valueChangeFlagPosition=generateValueChangeFlagPosition(this.scope))}function SelectModel(options){options=_.extend({"selectId":"","values":[],"mode":"single"},options);WidgetBaseModel.call(this,options)}function RadioGroupModel(options){SelectModel.call(this,options)}function TextBoxModel(options){options=_.extend({"value":""},options);WidgetBaseModel.call(this,options)}function ComboModel(options){options=_.extend({"ChildrenModels":function(){throw new Error("must be override this function!")},"min":0,"max":0,"defaultCount":1,"values":[]},options);WidgetBaseModel.call(this,options)}function SelectWindowModel(options){if(!options||!options.windowId)throw new Error("lose necessary option: windowId");var windowOptions=options&&options.windowOptions;if(!windowOptions||!windowOptions.winId||!windowOptions.content)throw new Error("lose necessary windowOptions: winId, content");options.windowOptions=_.extend({"winId":"","content":"","title":"","height":"300px","width":"450px","content-type":"url","btnOkLabel":"OK","btnCancelLabel":"Cancel"},windowOptions);options=_.extend({"windowId":"","value":{}},options);WidgetBaseModel.call(this,options)}function PaginationModel(options){options=_.extend({"useMarks":!1,"marks":[],"callback":_.bind(this.callbackFn,this),"selectId":"","data":[],"currentPage":1,"displayLength":10,"totalRecords":0,"curPage":{"pageIndex":1}},options);WidgetBaseModel.call(this,options)}function TableModel(options){if(!options||!options.columns)throw new Error("lose necessary option: columns");options=_.extend({"columns":[],"renderRow":_.bind(this.renderRowFn,this)},options);PaginationModel.call(this,options)}function SliderModel(options){checkNecessaryOptions(["from","to","step","scale"],options);options=_.extend({"value":options.from},options);WidgetBaseModel.call(this,options)}function SpinnerModel(options){checkNecessaryOptions(["max","min","step"],options);TextBoxModel.call(this,options)}function DatetimeModel(options){options=_.extend({"defaultDate":"","defaultTime":"","type":"datetime","onClose":_.bind(this.onCloseFn,this)},options);TextBoxModel.call(this,options)}function generateUniqueInt(){window.uniqueIntBase||(window.uniqueIntBase=0);return window.uniqueIntBase++}function generateValueChangeFlagPosition(scope){var valueChangeFlagsPosition="valueChangeFlags",valueChangeFlagPosition="valueChangeFlag"+generateUniqueInt();scope[valueChangeFlagsPosition]=scope[valueChangeFlagsPosition]||{};scope[valueChangeFlagsPosition][valueChangeFlagPosition]={"flag":{}};return valueChangeFlagsPosition+"."+valueChangeFlagPosition}function scopeApply(scope){setTimeout(function(){scope.$apply()},0)}function modelsEachDo(models,functionName,modelNameReg){var reg=modelNameReg||MODEL_NAME_REG;_.each(models,function(e,key){reg.test(key)&&e[functionName]&&e[functionName]()})}function modelsFindFlag(models,functionName,findFlag,modelNameReg){var reg=modelNameReg||MODEL_NAME_REG;return _.some(models,function(e,key){if(reg.test(key)&&e[functionName])return e[functionName]()===findFlag})}function getModelsValuesPromise(models,modelNameReg){var reg=modelNameReg||MODEL_NAME_REG,valuePromises=[],valueNames=[];_.each(models,function(model,key){if(reg.test(key)&&model.getValuePromise){valuePromises.push(model.getValuePromise());valueNames.push(key)}});if(0===valuePromises.length)return $q.resolve({});return $q.all(valuePromises).then(function(values){var result={};_.each(values,function(value,index){result[valueNames[index]]=value});return result})}function initWatch(scope,watchValues,initFn){if(watchValues.length>0)var unbindInitWatch=scope.$watch(function(){var dependency=[];_.each(watchValues,function(item){dependency.push(getAttributeByString(scope,item))});return dependency},function(values){var haveUndefinedWatchValues=_.some(values,function(value){return!value});if(!haveUndefinedWatchValues){unbindInitWatch();initFn()}},!0);else initFn()}$q.resolve=$q.resolve||function(data){var defer=$q.defer();defer.resolve(data);return defer.promise};var MODEL_NAME_REG=/.*Model$/;this.extend=extend;extend(WidgetBaseModel,{"getValueChangeFlag":function(){return getAttributeByString(this.scope,this.valueChangeFlagPosition)},"init":function(){var self=this;self.dependency&&self.dependency.length>0?self.destroy=self.scope.$watch(function(){var dependency=[];_.each(self.dependency,function(item){dependency.push(getAttributeByString(self.scope,item).flag)});return dependency},function(){self.refresh()},!0):self.refresh()},"initFn":function(){},"refresh":function(){this.initFn()},"getValuePromise":function(){if(this.valuePromiseChangeFlag!==this.getValueChangeFlag().flag||!this.valuePromise){this.valuePromise=this.updateValuePromise();this.valuePromiseChangeFlag=this.getValueChangeFlag().flag;var self=this;try{self.valuePromise.then(function(){},function(){self.valuePromiseChangeFlag=0/0})}catch(e){throw new Error("updateValuePromise() must be return a promise!")}}return this.valuePromise},"validateFn":function(){if(!this.validate)return!0;if(!this.id)throw new Error("lose necessary option: id");return tinyWidget.UnifyValid.FormValid($("#"+this.id))},"destroy":function(){this.dependency&&this.dependency.length>0},"updateValuePromise":function(){throw new Error("must be override this function and return a promise!")}});this.WidgetBaseModel=WidgetBaseModel;extend(SelectModel,WidgetBaseModel,{"select":function(selectId){"multiple"===this.mode&&(selectId=selectId.slice(0));this.getValueChangeFlag().flag=this.selectId=selectId},"change":function(){var widget,id=this.id;if(!id)throw new Error("lose necessary option: id!");widget=this.widget=this.widget||$("#"+id).widget();widget&&this.select(widget.getSelectedId())},"sortValues":function(values){return values.sort(function(a,b){return a.label.localeCompare(b.label)})},"setValues":function(values,selectId){var selectValue,filterSelectId;if(!values||0===values.length){this.select("");this.values=[];return}values=this.sortValues(values);if("multiple"===this.mode){selectId&&(selectValue=_.filter(values,function(value){return _.contains(selectId,value.selectId)}));if(selectValue){filterSelectId=[];_.each(selectValue,function(value){value.checked=!0;filterSelectId.push(value.selectId)});this.select(filterSelectId)}else this.select([])}else{selectId&&(selectValue=_.find(values,function(value){return value.selectId===selectId&&!value.disable}));selectValue||(selectValue=_.find(values,function(value){return!value.disable}));if(selectValue){selectValue.checked=!0;this.select(selectValue.selectId)}else this.select("")}this.values=values},"updateValuePromise":function(){var selectId=this.selectId;return $q.resolve("multiple"===this.mode?selectId&&_.filter(this.values,function(value){return _.contains(selectId,value.selectId)}):selectId&&_.find(this.values,function(value){return value.selectId===selectId}))}});this.SelectModel=SelectModel;extend(RadioGroupModel,SelectModel,{"click":function(event){var selectId=$(event.target.parentNode).attr("id");this.select(selectId)},"change":function(){var widget,id=this.id;if(!id)throw new Error("lose necessary option: id!");widget=this.widget=this.widget||$("#"+id).widget();widget&&this.select(widget.opChecked("checked"))},"setValues":function(values){_.each(values,function(value){value.selectId=value.key=value.selectId||value.key;value.label=value.text=value.label||value.text});SelectModel.prototype.setValues.apply(this,arguments)}});this.RadioGroupModel=RadioGroupModel;extend(TextBoxModel,WidgetBaseModel,{"change":function(){this.getValueChangeFlag().flag=this.value},"setValue":function(value){this.value=value;this.change()},"updateValuePromise":function(){return $q.resolve(this.value)}});this.TextBoxModel=TextBoxModel;extend(ComboModel,WidgetBaseModel,{"setValues":function(values){var defaultCount,i,self;if(values&&0!==values.length){self=this;_.each(values,function(value){self.add(value)})}else{defaultCount=this.defaultCount;for(i=0;defaultCount>i;i++)this.add()}},"add":function(value){if(0===this.max||this.values.length<this.max){var childrenModel=new this.ChildrenModels(value);modelsEachDo(childrenModel,"init");this.values.push(childrenModel);this.updateInnerWatch();return!0}return!1},"remove":function(index){if(this.values.length>this.min){modelsEachDo(this.values[index],"destroy");this.values.splice(index,1);this.updateInnerWatch();return!0}return!1},"clear":function(){var index,length=this.values.length;for(index=length-1;index>=this.min;index--)this.remove(index)},"getCount":function(){return this.values.length},"destroyInnerWatch":function(){},"updateInnerWatch":function(){var self=this;self.destroyInnerWatch();self.destroyInnerWatch=self.scope.$watch(function(){var dependency=[];_.each(self.values,function(models){_.each(models,function(model){model.valueChangeFlagPosition&&dependency.push(getAttributeByString(self.scope,model.valueChangeFlagPosition))})});return dependency},function(value){self.getValueChangeFlag().flag=value},!0)},"getValuePromise":function(){return WidgetBaseModel.prototype.getValuePromise.call(this).then(function(data){var valuesPromises=[];_.each(data,function(value){valuesPromises.push(getModelsValuesPromise(value))});return $q.all(valuesPromises)})},"validateFn":function(){return!_.find(this.values,function(value){return modelsFindFlag(value,"validateFn",!1)})},"updateValuePromise":function(){return $q.resolve(this.values)}});this.ComboModel=ComboModel;extend(SelectWindowModel,WidgetBaseModel,{"setValue":function(value){this.change(value)},"change":function(value){this.getValueChangeFlag().flag=this.value=value},"select":function(){var self=this,options=_.extend(self.windowOptions,{"value":self.value,"buttons":[{"label":self.windowOptions.btnOkLabel,"focused":!0,"handler":function(){var windowScope=$("#"+self.windowId).scope();if(modelsFindFlag(windowScope,"validateFn",!1))return;getModelsValuesPromise(windowScope).then(function(data){self.change(data)});win.destroy()}},{"label":self.windowOptions.btnCancelLabel,"focused":!1,"handler":function(){win.destroy()}}]}),win=new tinyWidget.Window(options);win.show()},"updateValuePromise":function(){return $q.resolve(this.value)}});this.SelectWindowModel=SelectWindowModel;extend(PaginationModel,WidgetBaseModel,{"select":function(selectId){this.getValueChangeFlag().flag=this.selectId=selectId;scopeApply(this.scope)},"sortValues":function(values){return values},"setValues":function(values,totalRecords,selectId){if(this.useMarks){totalRecords>this.displayLength&&values.pop();totalRecords=(this.currentPage-1)*this.displayLength+totalRecords}this.totalRecords=totalRecords;if(!values||0===values.length){this.select("");this.data=[];return}values=this.sortValues(values);var selectValue;selectId&&(selectValue=_.find(values,function(value){return value.selectId===selectId}));selectValue||(selectValue=_.find(values,function(value){return!value.disable}));if(selectValue){selectValue.checked=!0;this.select(selectValue.selectId)}else this.select("");this.data=values},"updateValuePromise":function(){var selectId=this.selectId;return $q.resolve(selectId&&_.find(this.data,function(value){return value.selectId===selectId}))},"getMark":function(){return this.marks[this.marks.length-1]},"getStart":function(){return(this.currentPage-1)*this.displayLength},"callbackFn":function(evtObj){var sub,i;if(this.useMarks)if(this.currentPage<evtObj.currentPage)this.marks.push(this.data[this.displayLength-1]);else{sub=this.currentPage-evtObj.currentPage;for(i=0;sub>i;i++)this.marks.pop()}this.currentPage=evtObj.currentPage;this.initFn()},"refresh":function(){this.marks=[];this.currentPage=1;this.curPage={"pageIndex":1};this.totalRecords=0;this.initFn()}});this.PaginationModel=PaginationModel;extend(TableModel,PaginationModel,{"renderRowFn":function(nRow,aData,iDataIndex){var radioIdBase="radios_"+this.getValueChangeFlag().flag+"_id_",radio=new tinyWidget.Radio({"id":radioIdBase+iDataIndex,"checked":aData.checked,"disable":aData.disable,"name":radioIdBase}),self=this;radio.on("click",function(){self.select(aData.selectId)});$("td:eq(0)",nRow).html(radio.getDom())}});this.TableModel=TableModel;extend(SliderModel,WidgetBaseModel,{"setValue":function(value,noCheck){var a,b,left,right,min=this.from,max=this.to;if(noCheck);else if(value instanceof Array){a=value[0];b=value[1];left=b>a?a:b;right=a>b?a:b;value=getLimitValue(left,min,max)+";"+getLimitValue(right,min,max)}else value=getLimitValue(value,min,max);this.getValueChangeFlag().flag=this.value=value},"change":function(){var widget,id=this.id;if(!id)throw new Error("lose necessary option: id!");widget=this.widget=this.widget||$("#"+id).widget();widget&&this.setValue(widget.option("value"),!0)},"updateValuePromise":function(){var tmp,value=this.value;if(value.split){tmp=value.split(";");value=tmp.length>1?[Number(tmp[0]),Number(tmp[1])]:Number(value)}return $q.resolve(value)}});this.SliderModel=SliderModel;extend(SpinnerModel,TextBoxModel,{"setValue":function(value){this.getValueChangeFlag().flag=this.value=getLimitValue(value,this.min,this.max)},"updateValuePromise":function(){return $q.resolve(Number(this.value))}});this.SpinnerModel=SpinnerModel;extend(DatetimeModel,TextBoxModel,{"setValue":function(value){switch(this.type){case"date":this.defaultDate=value;break;case"time":this.defaultTime=value;break;default:var datetime=value&&value.split(" ")||[];this.defaultDate=datetime[0];this.defaultTime=datetime[1]}this.value=this.getValueChangeFlag().flag=value},"onCloseFn":function(date){this.setValue(date)},"getValuePromise":function(){WidgetBaseModel.prototype.getValuePromise.call(this);"time"===this.type&&(this.valuePromiseChangeFlag=0/0);return this.valuePromise},"updateValuePromise":function(){var id,widget;if("time"===this.type){id=this.id;if(!id)throw new Error("lose necessary option: id");widget=this.widget=this.widget||$("#"+id).widget();this.value=widget?widget.getDateTime():""}return TextBoxModel.prototype.updateValuePromise.call(this)}});this.DatetimeModel=DatetimeModel;this.generateUniqueInt=generateUniqueInt;this.generateValueChangeFlagPosition=generateValueChangeFlagPosition;this.scopeApply=scopeApply;this.modelsEachDo=modelsEachDo;this.modelsFindFlag=modelsFindFlag;this.getModelsValuesPromise=getModelsValuesPromise;this.initWatch=initWatch};widgetModelsService.$injector=["$q"];return widgetModelsService});