define(["app-remote/services/tipMsgService","app-remote/services/tinyWindowTipMsgService","language/common","language/common-names"],function(tipMessageService,windowTipService,i18n,commonNames){"use strict";function extend(obj){for(var k in obj)exceptionCollection[k]=obj[k]}var exception,exceptionCollection={};require(["language/exception/meter-exception"],function(Exc){extend(Exc)});require(["language/exception/sa-exception"],function(Exc){extend(Exc)});require(["language/exception/vdc-exception"],function(Exc){extend(Exc)});require(["language/exception/omm-exception"],function(Exc){extend(Exc)});require(["language/exception/fault-exception"],function(Exc){extend(Exc)});require(["language/exception/irm-rpool-exception"],function(Exc){extend(Exc)});require(["language/exception/vapp-exception"],function(Exc){extend(Exc)});exception=function(){function combineExtendParams(msg,params){var tmpParams;tmpParams=_.map(params,function(item){_.each(item,function(val,idx){item[idx]=getCommonNames(val)});return i18nReplace(msg,item)});return tmpParams.join(" ")}function getCommonNames(nameStr){var names=nameStr.split(", "),convertName=_.map(names,function(item){return commonNames[item]||item});return convertName.join(",")}var isRedirection,i18nSubRegRex=/\{\s*([^\|\}]+?)\s*(?:\|([^\}]*))?\s*\}/g,i18nReplace=function(s,o){if(!s||!o)return;return s.replace?s.replace(i18nSubRegRex,function(match,key){return angular.isUndefined(o[key])?match:o[key]}):s};this.doException=function(response,exceptionI18n,windowId,params){params=params||{};var message=this.getMessage(response,exceptionI18n);this.showMsg(message,"error",windowId,params)};this.showMsg=function(message,type,windowId,params){var marginLeft,windowTip,tipMessage;params=params||{};marginLeft=params.marginLeft||0;if(windowId){windowTip=new windowTipService(windowId);windowTip.alert(type||"success",message)}else{tipMessage=new tipMessageService;tipMessage.alert(type||"success",message,marginLeft)}};this.getMessage=function(response,exceptionI18n){var responseObj,code,messageObj,message="";try{responseObj=response;if(response.responseText){responseObj=JSON.parse(response.responseText);responseObj.message=htmlDecode.done(responseObj.message)}code=responseObj.error&&responseObj.error.code||responseObj.code;if(exceptionI18n){messageObj=exceptionI18n[code];if(messageObj)return responseObj.extendParams&&responseObj.extendParams.length?combineExtendParams(messageObj.cause,responseObj.extendParams)+" "+(messageObj.solution||""):messageObj.cause+" "+(messageObj.solution||"");messageObj=exceptionCollection[code];return messageObj?responseObj.extendParams&&responseObj.extendParams.length?combineExtendParams(messageObj.cause,responseObj.extendParams)+" "+(messageObj.solution||""):messageObj.cause+" "+(messageObj.solution||""):responseObj.message}messageObj=exceptionCollection[code];return messageObj?responseObj.extendParams&&responseObj.extendParams.length?combineExtendParams(messageObj.cause,responseObj.extendParams)+" "+(messageObj.solution||""):messageObj.cause+" "+(messageObj.solution||""):responseObj.message}catch(e){}message=message||i18n.common_term_systemBusyTryLater_valid||"";return message};this.getFailReason=function(responseObj){var code=responseObj.code||"",messageObj=exceptionCollection[code];return messageObj?responseObj.extendParams&&responseObj.extendParams.length?combineExtendParams(messageObj.cause,responseObj.extendParams):messageObj.cause:responseObj.message};this.getException=function(code,exceptI18n){if(exceptI18n&&exceptI18n[code])return exceptI18n[code];if(exceptionCollection)return exceptionCollection[code];return""};this.isException=function(response){if(!response||/^2\d\d$/.test(response.status)||""===response.responseText&&401!==response.status||isRedirection(response.responseText))return!1;return!0};isRedirection=function(responseText){if("string"==typeof responseText)try{var jsonObj=JSON.parse(responseText);if("0003005010"===jsonObj.code)return!0;return!1}catch(e){return!1}return!1}};return exception});